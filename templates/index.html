<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cold Call Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="theme-color" content="#cc0000" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}" />
  <script>
    function openModal(){ document.getElementById('callModal').classList.add('open'); }
    function closeModal(){ document.getElementById('callModal').classList.remove('open'); }
  </script>
</head>
<body>

  <!-- Header -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand-wrap">
        <img src="{{ url_for('static', filename='tynan_logo.png') }}" class="logo-img" alt="Tynan" />
        <div class="brand-title">Cold Call Tracker</div>
        <img src="{{ url_for('static', filename='heli_logo.png') }}" class="logo-img" alt="HELI" />
      </div>
      <nav class="topnav">
        <a href="/">Dashboard</a>
        <a href="/schedule">Schedule</a>
        <a href="/logout">Logout</a>
      </nav>
    </div>
  </header>

  <div class="shell">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sb-title">MENU</div>
      <div class="sb-nav">
        <a class="sb-btn active" href="/">Dashboard</a>
        <button class="sb-btn" type="button" onclick="openModal()">ðŸ“ž Log New Call</button>
        <a class="sb-btn" href="/schedule">ðŸ“… Schedule</a>
        <a class="sb-btn" href="/logout">Logout</a>
      </div>
      <div class="sb-legend">
        <div class="legend-item"><span class="legend-dot red"></span> Follow-up overdue</div>
        <div class="legend-item"><span class="legend-dot gray"></span> Due today</div>
      </div>
      <hr class="mt-12 mb-8">
      <div class="subtle">Welcome, <strong>{{ user }}</strong></div>
    </aside>

    <!-- Main content (scrolls naturally) -->
    <main>

      <!-- Reminders -->
      <section class="panel">
        <h2 class="section-title">Reminders</h2>
        <div class="reminders">
          {% if reminders %}
            {% for r in reminders %}
              <div class="rem-card">
                <h3>{{ r['company'] }}</h3>
                <div class="k">Last contacted: {{ r['days_ago'] }} days ago</div>
                <div class="k">Suggested Action: <strong>{{ r['action'] }}</strong></div>
              </div>
            {% endfor %}
          {% else %}
            <div class="rem-card">
              <h3>Nothing due today</h3>
              <div class="k">You're all caught up.</div>
            </div>
          {% endif %}
          <div class="rem-card red">
            <h3>Log a New Cold Call</h3>
            <button class="cta" type="button" onclick="openModal()">Open form</button>
          </div>
        </div>
      </section>

      <!-- Past Cold Calls -->
      <section class="panel mt-16">
        <div class="section-head">
          <h2 class="section-title">Past Cold Calls</h2>
          <!-- Search bar sits directly above the table -->
          <div class="toolbar" aria-label="Filter past calls" style="margin-top:8px">
            <input id="callSearch" class="input searchbar" type="search" inputmode="search"
                   enterkeyhint="search" autocapitalize="off" autocomplete="off"
                   placeholder="Search company, contact, email, phoneâ€¦" />
            <button class="btn ghost" type="button" id="clearSearch">Clear</button>
            <div class="right subtle" id="matchCount" aria-live="polite"></div>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Company</th>
                <th>Contact Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Address</th>
                <th>Notes</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="callsBody">
              {% for month, calls in calls_by_month.items() %}
                <tr class="month-header touch-target" data-month="{{ month }}" id="mhead-{{ month.replace(' ', '-') }}">
                  <td colspan="7" style="font-weight:800">
                    <span class="chev">â–¸</span>
                    <span class="mh-label">{{ month }}</span>
                    <span class="mh-count" aria-hidden="true"></span>
                  </td>
                </tr>
                {% for call in calls %}
                  <tr
                    class="call-row month-{{ month.replace(' ', '-') }}"
                    data-month-key="{{ month.replace(' ', '-') }}"
                    data-company="{{ (call['company'] or '')|e }}"
                    data-contact="{{ (call['contact_name'] or '')|e }}"
                    data-email="{{ (call['email'] or '')|e }}"
                    data-phone="{{ (call['phone'] or '')|e }}"
                    data-address="{{ (call['address'] or '')|e }}"
                    data-date="{{ call['date_called'] }}"
                    style="display:none;"
                  >
                    <td data-label="Company"><strong>{{ call['company'] }}</strong></td>
                    <td data-label="Contact Name">{{ call['contact_name'] or 'â€”' }}</td>
                    <td data-label="Email">{{ call['email'] or 'â€”' }}</td>
                    <td data-label="Phone">{{ call['phone'] or 'â€”' }}</td>
                    <td data-label="Address">{{ call['address'] or 'â€”' }}</td>
                    <td data-label="Notes" style="white-space:pre-wrap">{{ call['notes'] or 'â€”' }}</td>
                    <td data-label="Actions">
                      <div class="row-actions">
                        <a href="/edit_call/{{ call['id'] }}" class="btn sm ghost">Edit</a>
                        <a href="/delete_call/{{ call['id'] }}" class="btn sm primary" onclick="return confirm('Are you sure?')">Delete</a>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

<!-- Add Call Modal (with Business Card Scan) -->
<div class="modal" id="callModal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="newCallTitle">
    <div class="head">
      <h2 id="newCallTitle" class="mt-0 mb-0">Log a New Cold Call</h2>
      <button class="btn icon ghost" type="button" aria-label="Close" onclick="closeModal()">âœ•</button>
    </div>

    <div class="body">
      <!-- SCAN CONTROLS -->
      <div class="scan-row">
        <input id="cardInput" type="file" accept="image/*" capture="environment" style="display:none" />
        <button class="scan-btn" type="button" id="scanBtn">ðŸ“· Scan business card</button>
        <span class="scan-note">Auto-fill company, name, email, phone from a photo.</span>
      </div>
      <div id="scanPreview" class="scan-preview" style="display:none">
        <img id="cardPreview" alt="Business card preview">
        <div>
          <div class="scan-progress" id="scanProgress">Scanningâ€¦</div>
          <div class="subtle" id="scanHints" style="margin-top:4px"></div>
        </div>
      </div>

      <!-- FORM -->
      <form id="newcall-form" action="/add" method="POST" class="form form-vertical" autocomplete="on">
        <div class="form-grid">
          <div class="field col-6">
            <label class="label" for="company">Company <span class="subtle">(required)</span>
              <span id="badgeCompany" class="badge-auto" style="display:none">auto</span>
            </label>
            <input id="company" class="input" type="text" name="company" required
                   placeholder="Acme Manufacturing" autocomplete="organization">
          </div>

          <div class="field col-6">
            <label class="label" for="contact_name">Contact Name
              <span id="badgeName" class="badge-auto" style="display:none">auto</span>
            </label>
            <input id="contact_name" class="input" type="text" name="contact_name"
                   placeholder="Jane Smith" autocomplete="name">
          </div>

          <div class="field col-6">
            <label class="label" for="phone">Phone
              <span id="badgePhone" class="badge-auto" style="display:none">auto</span>
            </label>
            <input id="phone" class="input" type="tel" inputmode="tel" name="phone"
                   placeholder="(317) 555-0199" autocomplete="tel">
          </div>

          <div class="field col-6">
            <label class="label" for="email">Email
              <span id="badgeEmail" class="badge-auto" style="display:none">auto</span>
            </label>
            <input id="email" class="input" type="email" name="email"
                   placeholder="jane@acme.com" autocomplete="email">
          </div>

          <div class="field col-12">
            <label class="label" for="address">Address
              <span id="badgeAddress" class="badge-auto" style="display:none">auto</span>
            </label>
            <input id="address" class="input" type="text" name="address"
                   placeholder="123 Commerce Dr, Indianapolis IN" autocomplete="street-address">
          </div>

          <div class="field col-12">
            <label class="label" for="notes">Notes</label>
            <textarea id="notes" class="textarea" name="notes" rows="4"
                      placeholder="Left voicemailâ€¦"></textarea>
          </div>
        </div>
      </form>
    </div>

    <div class="foot">
      <button class="btn" type="button" onclick="closeModal()">Cancel</button>
      <button class="btn primary" form="newcall-form" type="submit">Add Call</button>
    </div>
  </div>
</div>

  <script>
    // ===== Month accordion with persistence =====
    const closedKey = 'cc_closedMonths';
    function getClosedSet(){ try{ return new Set(JSON.parse(localStorage.getItem(closedKey) || '[]')); } catch{ return new Set(); } }
    function saveClosedSet(set){ localStorage.setItem(closedKey, JSON.stringify(Array.from(set))); }
    const closed = getClosedSet();

    function setMonthState(monthSlug, open){
      const rows = document.querySelectorAll(`.month-${monthSlug}`);
      rows.forEach(r => r.style.display = open ? 'table-row' : 'none');
      const head = document.getElementById(`mhead-${monthSlug}`);
      if (head){
        const chev = head.querySelector('.chev');
        if (chev) chev.textContent = open ? 'â–¾' : 'â–¸';
      }
      if (!open) closed.add(monthSlug); else closed.delete(monthSlug);
      saveClosedSet(closed);
    }

    // initialize accordions + counts
    document.querySelectorAll('.month-header').forEach(h=>{
      const month = h.dataset.month;
      const slug = month.replace(/\s/g,'-');
      const count = document.querySelectorAll(`.month-${slug}`).length;
      const badge = h.querySelector('.mh-count');
      if (badge){ badge.textContent = `Â· ${count}`; }
      const open = !closed.has(slug);
      setMonthState(slug, open);
      h.addEventListener('click', ()=> {
        const firstRow = document.querySelector(`.month-${slug}`);
        const nowOpen = firstRow && firstRow.style.display !== 'none';
        setMonthState(slug, !nowOpen);
      }, {passive:true});
    });

    // ===== Live filter (search just above Past Calls) =====
    const input = document.getElementById('callSearch');
    const clearBtn = document.getElementById('clearSearch');
    const matchCount = document.getElementById('matchCount');
    const allRows = Array.from(document.querySelectorAll('tbody tr.call-row'));

    function expandAllMonths(){
      document.querySelectorAll('.month-header').forEach(h=>{
        const slug = h.dataset.month.replace(/\s/g,'-');
        setMonthState(slug, true);
      });
    }

    function filterCalls(){
      const q = (input.value || '').trim().toLowerCase();
      let matches = 0;
      if (q) expandAllMonths();
      allRows.forEach(row => {
        const hay = ((row.dataset.company||'')+' '+(row.dataset.contact||'')+' '+(row.dataset.email||'')+' '+(row.dataset.phone||'')+' '+(row.dataset.address||'')).toLowerCase();
        const show = !q || hay.includes(q);
        row.style.display = show ? 'table-row' : 'none';
        if (show) matches++;
      });
      matchCount.textContent = q ? `${matches} match${matches===1?'':'es'}` : '';
    }
    input.addEventListener('input', filterCalls, {passive:true});
    input.addEventListener('keydown', e=>{ if (e.key === 'Enter') e.preventDefault(); });
    clearBtn.addEventListener('click', ()=>{ input.value=''; filterCalls(); input.focus(); });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/sw.js').catch(()=>{});
    }
  </script>

<!-- Tesseract.js -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
  // ===== Improved business card scan: rotation + preprocessing + scoring parser =====
  const scanBtn = document.getElementById('scanBtn');
  const fileInput = document.getElementById('cardInput');
  const previewWrap = document.getElementById('scanPreview');
  const previewImg = document.getElementById('cardPreview');
  const scanProgress = document.getElementById('scanProgress');
  const scanHints = document.getElementById('scanHints');

  const fCompany = document.getElementById('company');
  const fName    = document.getElementById('contact_name');
  const fEmail   = document.getElementById('email');
  const fPhone   = document.getElementById('phone');
  const fAddr    = document.getElementById('address');

  const bCompany = document.getElementById('badgeCompany');
  const bName    = document.getElementById('badgeName');
  const bEmail   = document.getElementById('badgeEmail');
  const bPhone   = document.getElementById('badgePhone');
  const bAddr    = document.getElementById('badgeAddress');

  function showBadge(el, show){ if(el) el.style.display = show ? '' : 'none'; }

  if (scanBtn && fileInput){
    scanBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleImageSelect);
  }

  async function handleImageSelect(){
    const file = fileInput.files && fileInput.files[0];
    if (!file) return;

    const objectUrl = URL.createObjectURL(file);
    previewImg.src = objectUrl;
    previewWrap.style.display = '';
    scanProgress.textContent = 'Scanningâ€¦';
    scanHints.textContent = '';

    const dataUrl = await downscaleImage(file, 1600);
    const rotated = await autoRotate(dataUrl);
    const prepped = await preprocessImage(rotated);
    await runOCR(prepped);

    URL.revokeObjectURL(objectUrl);
  }

  function downscaleImage(file, maxW){
    return new Promise((resolve,reject)=>{
      const img = new Image();
      let localURL = '';
      img.onload = ()=>{
        const ratio = Math.min(1, maxW / img.width);
        const w = Math.round(img.width * ratio);
        const h = Math.round(img.height * ratio);
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        URL.revokeObjectURL(localURL);
        resolve(canvas.toDataURL('image/jpeg', 0.9));
      };
      img.onerror = reject;
      localURL = URL.createObjectURL(file);
      img.src = localURL;
    });
  }

  async function autoRotate(dataUrl){
    try{
      const det = await Tesseract.detect(dataUrl);
      const deg = det?.data?.orientation?.deg || 0;
      if (!deg) return dataUrl;
      return await rotateImage(dataUrl, deg);
    }catch{ return dataUrl; }
  }
  function rotateImage(dataUrl, deg){
    return new Promise((resolve)=>{
      const img = new Image();
      img.onload = ()=>{
        const rad = deg * Math.PI / 180;
        const sin = Math.abs(Math.sin(rad)), cos = Math.abs(Math.cos(rad));
        const w = img.width, h = img.height;
        const canvas = document.createElement('canvas');
        canvas.width = Math.round(w*cos + h*sin);
        canvas.height = Math.round(w*sin + h*cos);
        const ctx = canvas.getContext('2d');
        ctx.translate(canvas.width/2, canvas.height/2);
        ctx.rotate(rad);
        ctx.drawImage(img, -w/2, -h/2);
        resolve(canvas.toDataURL('image/jpeg', 0.92));
      };
      img.src = dataUrl;
    });
  }

  // Grayscale + mild contrast + binarize => helps OCR on typical cards
  function preprocessImage(dataUrl){
    return new Promise((resolve)=>{
      const img = new Image();
      img.onload = ()=>{
        const c = document.createElement('canvas');
        c.width = img.width; c.height = img.height;
        const ctx = c.getContext('2d');
        ctx.drawImage(img, 0, 0);
        const id = ctx.getImageData(0,0,c.width,c.height);
        const d = id.data;
        for (let i=0;i<d.length;i+=4){
          const r=d[i],g=d[i+1],b=d[i+2];
          let y = 0.299*r + 0.587*g + 0.114*b;
          y = (y-128)*1.18 + 132;         // contrast ~1.18, brightness +4
          d[i]=d[i+1]=d[i+2]=y;
        }
        ctx.putImageData(id,0,0);

        const id2 = ctx.getImageData(0,0,c.width,c.height);
        const p = id2.data;
        let sum=0, n=p.length/4;
        for(let i=0;i<p.length;i+=4) sum += p[i];
        const thr = sum/n;
        for(let i=0;i<p.length;i+=4){
          const v = p[i] > thr ? 255 : 0;
          p[i]=p[i+1]=p[i+2]=v;
        }
        ctx.putImageData(id2,0,0);
        resolve(c.toDataURL('image/png', 1));
      };
      img.src = dataUrl;
    });
  }

  async function runOCR(preppedDataUrl){
    try{
      const worker = await Tesseract.createWorker('eng', 1, {
        logger: m => {
          if (m.status === 'recognizing text' && m.progress != null){
            scanProgress.textContent = `Scanningâ€¦ ${(m.progress*100).toFixed(0)}%`;
          }
        }
      });

      // Pass 1: PSM 4 (single column), DPI 300
      await worker.setParameters({ tessedit_pageseg_mode: '4', user_defined_dpi: '300' });
      const { data: { text: t1 } } = await worker.recognize(preppedDataUrl);
      let parsed = parseBusinessCard(t1 || '');

      // Pass 2: PSM 6 (uniform block) â€“ merge if missing key fields
      await worker.setParameters({ tessedit_pageseg_mode: '6' });
      const { data: { text: t2 } } = await worker.recognize(preppedDataUrl);
      parsed = mergeParsed(parsed, parseBusinessCard(t2 || ''));

      await worker.terminate();

      scanProgress.textContent = 'Done. Review & save.';
      fillFields(parsed);
      scanHints.innerHTML = (parsed._hints || []).join(' Â· ');
    }catch(err){
      console.error(err);
      scanProgress.textContent = 'Scan failed. You can still type fields manually.';
      scanHints.textContent = 'Tip: good light, flat card, fill the frame.';
    }
  }

  // ===== Smarter parser with scoring =====
  const TITLE_WORDS = /^(owner|founder|co[-\s]?founder|ceo|cfo|coo|cto|vp|svp|evp|manager|director|sales|account|rep|engineer|operations|marketing|service|technician|advisor|consultant)\b/i;
  const ORG_SUFFIX = /\b(llc|inc\.?|corp\.?|co\.?|company|industries|holdings|group|plc|ltd|llp)\b/i;
  const WEB_OR_EMAIL = /(@|www\.|https?:\/\/)/i;
  const GENERIC_EMAIL_DOMAINS = ['gmail','yahoo','outlook','hotmail','icloud','aol','proton','msn','live','me'];

  function parseBusinessCard(raw){
    const lines = (raw||'')
      .replace(/\r/g,'')
      .split('\n')
      .map(l=>l.replace(/[â€¢Â·â–ªâ—]+/g,' ').trim())
      .filter(Boolean);

    // Clean duplicates
    const uniq = Array.from(new Set(lines));

    const out = { company:'', name:'', email:'', phone:'', address:'', _hints:[] };

    // EMAIL (most reliable)
    const emailMatch = raw.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
    if (emailMatch){ out.email = emailMatch[0]; }

    // PHONE (prefer labeled mobile/cell)
    const labeled = (raw.match(/(?:mobile|cell|m:|c:)\s*[:\-]?\s*(\+?\d[\d\s().-]{7,}\d)/ig) || [])
      .map(s=>s.replace(/(?:mobile|cell|m:|c:)\s*[:\-]?\s*/i,'').trim());
    const allPhones = labeled.length ? labeled : (raw.match(/(?:\+?\d[\d\s().-]{7,}\d)/g) || []);
    if (allPhones.length){ out.phone = formatPhone(allPhones[0]); }

    // COMPANY: score candidates (early lines, ALL CAPS, org suffix)
    let bestCompany = {score:-1,line:''};
    uniq.slice(0,8).forEach((l,idx)=>{
      const score = scoreCompanyLine(l, idx);
      if (score > bestCompany.score) bestCompany = {score, line:l};
    });
    if (bestCompany.score >= 2) out.company = cleanCompany(bestCompany.line);

    // NAME:
    // 1) If a title line exists (Manager/Director/etc), take previous proper-case line as name
    let nameFromTitle = '';
    uniq.forEach((l, i)=>{
      if (TITLE_WORDS.test(l) && i>0 && isProperName(uniq[i-1])) nameFromTitle = uniq[i-1];
    });
    // 2) Otherwise, highest-scoring proper name anywhere
    let bestName = {score:-1,line:''};
    uniq.forEach(l=>{
      const s = scoreNameLine(l);
      if (s > bestName.score) bestName = {score:s, line:l};
    });
    out.name = (nameFromTitle || bestName.line || '').trim();

    // ADDRESS: try City, ST ZIP pattern + street above it
    out.address = extractAddress(uniq);

    // Derive missing from email
    if (out.email){
      const [user, domain] = out.email.split('@');
      const base = (domain||'').split('.')[0] || '';
      if (!out.company && base && !GENERIC_EMAIL_DOMAINS.includes(base.toLowerCase())){
        out.company = titleCase(base.replace(/[-_]/g,' '));
      }
      if (!out.name && user){
        const parts = user.split(/[._-]+/).filter(p=>p.length>1 && !/^\d+$/.test(p));
        if (parts.length>=2) out.name = parts.map(titleCase).join(' ');
      }
    }

    if (out.email) out._hints.push('email');
    if (out.phone) out._hints.push('phone');
    if (out.name) out._hints.push('name');
    if (out.company) out._hints.push('company');
    if (out.address) out._hints.push('address');

    return out;
  }

  function scoreCompanyLine(l, idx){
    if (!l || WEB_OR_EMAIL.test(l)) return -5;
    const letters = l.replace(/[^A-Za-z]/g,'');
    const upper = letters.replace(/[a-z]/g,'').length;
    const upperRatio = letters ? upper/letters.length : 0;
    let s = 0;
    if (ORG_SUFFIX.test(l)) s += 4;
    if (upperRatio > 0.7 && letters.length > 3) s += 3; // often a logo line
    if (letters.length >= 3 && letters.length <= 30) s += 1;
    if (idx <= 3) s += 1;           // company tends to be near top
    if (/\d/.test(l)) s -= 1;       // numbers less likely
    if (TITLE_WORDS.test(l)) s -= 2;
    return s;
  }
  function isProperName(l){
    // 2â€“3 words, each Capitalized (allow hyphen/'), not ALL CAPS, no digits, no org suffix
    if (!l || /\d|@|www|http/i.test(l)) return false;
    if (l === l.toUpperCase()) return false;
    if (ORG_SUFFIX.test(l)) return false;
    const words = l.split(/\s+/).filter(Boolean);
    if (words.length < 2 || words.length > 3) return false;
    return words.every(w => /^[A-Z][a-z]+(?:[-'][A-Z][a-z]+)?$/.test(w));
  }
  function scoreNameLine(l){
    if (!isProperName(l)) return -1;
    // Prefer lines not containing titles; moderate length
    let s = 3;
    if (!TITLE_WORDS.test(l)) s += 1;
    const len = l.length;
    if (len >= 5 && len <= 28) s += 1;
    return s;
  }

  function extractAddress(lines){
    const cszRx = /^[A-Za-z .'-]+,\s*[A-Z]{2}\s*\d{5}(?:-\d{4})?$/; // City, ST 12345
    const streetRx = /^\d{1,6}\s+[A-Za-z0-9.\- ]+\b(?:St|Street|Rd|Road|Ave|Avenue|Blvd|Drive|Dr|Ln|Lane|Way|Ct|Court|Pkwy|Parkway|Cir|Circle|Hwy|Highway)\b\.?/i;
    const suiteRx = /\b(Suite|Ste\.?|Unit|#)\s*\w+/i;

    let addr = '';
    let cszIndex = lines.findIndex(l => cszRx.test(l));
    if (cszIndex >= 0){
      // Look up to 3 lines above for street
      let streetLine = '';
      for (let i=cszIndex-1; i>=Math.max(0, cszIndex-3); i--){
        if (streetRx.test(lines[i])){ streetLine = lines[i]; break; }
      }
      let suiteLine = '';
      if (streetLine){
        // The line right after street or on same line
        const i = lines.indexOf(streetLine);
        if (suiteRx.test(streetLine)) suiteLine = '';
        else if (lines[i+1] && suiteRx.test(lines[i+1])) suiteLine = lines[i+1];
        addr = [streetLine, suiteLine, lines[cszIndex]].filter(Boolean).join(', ');
      }else{
        addr = lines[cszIndex];
      }
      return addr;
    }

    // Fallback: any street line + optional next suite/city line
    const sIdx = lines.findIndex(l => streetRx.test(l));
    if (sIdx >= 0){
      const parts = [lines[sIdx]];
      if (lines[sIdx+1] && (suiteRx.test(lines[sIdx+1]) || /[A-Za-z]/.test(lines[sIdx+1]))) parts.push(lines[sIdx+1]);
      if (lines[sIdx+2] && /[A-Z]{2}\s*\d{5}/.test(lines[sIdx+2])) parts.push(lines[sIdx+2]);
      addr = parts.join(', ');
    }
    return addr;
  }

  function mergeParsed(a,b){
    return {
      company: a.company || b.company,
      name:    a.name    || b.name,
      email:   a.email   || b.email,
      phone:   a.phone   || b.phone,
      address: a.address || b.address,
      _hints:  Array.from(new Set([...(a._hints||[]), ...(b._hints||[])]))
    };
  }

  function formatPhone(s){
    const digits = s.replace(/[^\d+]/g,'');
    const m = digits.match(/^\+?1?(\d{10})(?:\D*(\d{1,5}))?$/);
    if (m){
      const base = `(${m[1].slice(0,3)}) ${m[1].slice(3,6)}-${m[1].slice(6)}`;
      return m[2] ? `${base} x${m[2]}` : base;
    }
    return s.trim();
  }
  function cleanCompany(s){
    return s.replace(/\s{2,}/g,' ').replace(/\s+[|Â·\-â€“]\s+.*$/, '').trim();
  }
  function titleCase(w){
    return w.replace(/\b([a-z])/g, m=>m.toUpperCase())
            .replace(/\b(Of|And|The|For|At|On|In)\b/g, m=>m.toLowerCase());
  }

  function fillFields(p){
    if (p.company && fCompany && !fCompany.value){ fCompany.value = p.company; showBadge(bCompany,true); }
    if (p.name && fName && !fName.value){ fName.value = p.name; showBadge(bName,true); }
    if (p.email && fEmail && !fEmail.value){ fEmail.value = p.email; showBadge(bEmail,true); }
    if (p.phone && fPhone && !fPhone.value){ fPhone.value = p.phone; showBadge(bPhone,true); }
    if (p.address && fAddr && !fAddr.value){ fAddr.value = p.address; showBadge(bAddr,true); }

    const form = document.getElementById('newcall-form');
    if (form){ form.scrollIntoView({behavior:'smooth', block:'start'}); }
  }
</script>
</body>
</html>
