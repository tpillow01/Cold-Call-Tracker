<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cold Call Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="theme-color" content="#cc0000" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}" />

  <!-- Minimal inline helpers to ensure modal is scrollable on phones -->
  <style>
    body.noscroll { overflow: hidden; }
    .modal.open{ display:flex !important; align-items:center; justify-content:center; }
    .modal .dialog{ max-height:96dvh; width:min(720px, 96vw); display:flex; flex-direction:column; }
    .dialog .head{ position:sticky; top:0; z-index:2; }
    .dialog .body{ flex:1; min-height:0; overflow:auto; -webkit-overflow-scrolling:touch; }
    .dialog .foot{ position:sticky; bottom:0; z-index:2; }
  </style>

  <script>
    function openModal(){
      document.getElementById('callModal').classList.add('open');
      document.body.classList.add('noscroll');
    }
    function closeModal(){
      document.getElementById('callModal').classList.remove('open');
      document.body.classList.remove('noscroll');
    }
  </script>
</head>
<body>

  <!-- Header -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand-wrap">
        <img src="{{ url_for('static', filename='tynan_logo.png') }}" class="logo-img" alt="Tynan" />
        <div class="brand-title">Cold Call Tracker</div>
        <img src="{{ url_for('static', filename='heli_logo.png') }}" class="logo-img" alt="HELI" />
      </div>
      <nav class="topnav">
        <a href="/">Dashboard</a>
        <a href="/schedule">Schedule</a>
        <a href="/logout">Logout</a>
      </nav>
    </div>
  </header>

  <div class="shell">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sb-title">MENU</div>
      <div class="sb-nav">
        <a class="sb-btn active" href="/">Dashboard</a>
        <button class="sb-btn" type="button" onclick="openModal()">ðŸ“ž Log New Call</button>
        <a class="sb-btn" href="/schedule">ðŸ“… Schedule</a>
        <a class="sb-btn" href="/logout">Logout</a>
      </div>
      <div class="sb-legend">
        <div class="legend-item"><span class="legend-dot red"></span> Follow-up overdue</div>
        <div class="legend-item"><span class="legend-dot gray"></span> Due today</div>
      </div>
      <hr class="mt-12 mb-8">
      <div class="subtle">Welcome, <strong>{{ user }}</strong></div>
    </aside>

    <!-- Main content (scrolls naturally) -->
    <main>

      <!-- Reminders -->
      <section class="panel">
        <h2 class="section-title">Reminders</h2>
        <div class="reminders">
          {% if reminders %}
            {% for r in reminders %}
              <div class="rem-card">
                <h3>{{ r['company'] }}</h3>
                <div class="k">Last contacted: {{ r['days_ago'] }} days ago</div>
                <div class="k">Suggested Action: <strong>{{ r['suggestion'] }}</strong></div>
              </div>
            {% endfor %}
          {% else %}
            <div class="rem-card">
              <h3>Nothing due today</h3>
              <div class="k">You're all caught up.</div>
            </div>
          {% endif %}
          <div class="rem-card red">
            <h3>Log a New Cold Call</h3>
            <button class="cta" type="button" onclick="openModal()">Open form</button>
          </div>
        </div>
      </section>

      <!-- Past Cold Calls -->
      <section class="panel mt-16">
        <div class="section-head">
          <h2 class="section-title">Past Cold Calls</h2>
          <!-- Search bar sits directly above the table -->
          <div class="toolbar" aria-label="Filter past calls" style="margin-top:8px">
            <input id="callSearch" class="input searchbar" type="search" inputmode="search"
                   enterkeyhint="search" autocapitalize="off" autocomplete="off"
                   placeholder="Search company, contact, email, phoneâ€¦" />
            <button class="btn ghost" type="button" id="clearSearch">Clear</button>
            <div class="right subtle" id="matchCount" aria-live="polite"></div>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Company</th>
                <th>Contact Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Address</th>
                <th>Notes</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="callsBody">
              {% for month, calls in calls_by_month.items() %}
                <tr class="month-header touch-target" data-month="{{ month }}" id="mhead-{{ month|replace(' ', '-') }}">
                  <td colspan="7" style="font-weight:800">
                    <span class="chev">â–¸</span>
                    <span class="mh-label">{{ month }}</span>
                    <span class="mh-count" aria-hidden="true"></span>
                  </td>
                </tr>
                {% for call in calls %}
                  <tr
                    class="call-row month-{{ month|replace(' ', '-') }}"
                    data-month-key="{{ month|replace(' ', '-') }}"
                    data-company="{{ (call['company'] or '')|e }}"
                    data-contact="{{ (call['contact_name'] or '')|e }}"
                    data-email="{{ (call['email'] or '')|e }}"
                    data-phone="{{ (call['phone'] or '')|e }}"
                    data-address="{{ (call['address'] or '')|e }}"
                    data-date="{{ call['date_called'] }}"
                    style="display:none;"
                  >
                    <td data-label="Company"><strong>{{ call['company'] }}</strong></td>
                    <td data-label="Contact Name">{{ call['contact_name'] or 'â€”' }}</td>
                    <td data-label="Email">{{ call['email'] or 'â€”' }}</td>
                    <td data-label="Phone">{{ call['phone'] or 'â€”' }}</td>
                    <td data-label="Address">{{ call['address'] or 'â€”' }}</td>
                    <td data-label="Notes" style="white-space:pre-wrap">{{ call['notes'] or 'â€”' }}</td>
                    <td data-label="Actions">
                      <div class="row-actions">
                        <a href="/edit_call/{{ call['id'] }}" class="btn sm ghost">Edit</a>
                        <a href="/delete_call/{{ call['id'] }}" class="btn sm primary" onclick="return confirm('Are you sure?')">Delete</a>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

<!-- Add Call Modal (with Business Card Scan) -->
<div class="modal" id="callModal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="newCallTitle">
    <div class="head">
      <h2 id="newCallTitle" class="mt-0 mb-0">Log a New Cold Call</h2>
      <button class="btn icon ghost" type="button" aria-label="Close" onclick="closeModal()">âœ•</button>
    </div>

    <div class="body">
      <!-- SCAN CONTROLS -->
      <div class="scan-row">
        <input id="cardInput" type="file" accept="image/*" capture="environment" style="display:none" />
        <button class="scan-btn" type="button" id="scanBtn">ðŸ“· Scan business card</button>
        <span class="scan-note">Auto-fill company, name, email, phone from a photo.</span>
      </div>
      <div id="scanPreview" class="scan-preview" style="display:none">
        <img id="cardPreview" alt="Business card preview">
        <div>
          <div class="scan-progress" id="scanProgress">Scanningâ€¦</div>
          <div class="subtle" id="scanHints" style="margin-top:4px"></div>
        </div>
      </div>

      <!-- FORM -->
      <form id="newcall-form" action="/add" method="POST" class="form form-vertical" autocomplete="on">
        <div class="form-grid">
          <div class="field col-6">
            <label class="label" for="company">Company <span class="subtle">(required)</span>
              <span id="badgeCompany" class="badge-auto" style="display:none">auto</span>
            </label>
            <input id="company" class="input" type="text" name="company" required
                   placeholder="Acme Manufacturing" autocomplete="organization">
          </div>

          <div class="field col-6">
            <label class="label" for="contact_name">Contact Name
              <span id="badgeName" class="badge-auto" style="display:none">auto</span>
            </label>
            <input id="contact_name" class="input" type="text" name="contact_name"
                   placeholder="Jane Smith" autocomplete="name">
          </div>

          <div class="field col-6">
            <label class="label" for="phone">Phone
              <span id="badgePhone" class="badge-auto" style="display:none">auto</span>
            </label>
            <input id="phone" class="input" type="tel" inputmode="tel" name="phone"
                   placeholder="(317) 555-0199" autocomplete="tel">
          </div>

          <div class="field col-6">
            <label class="label" for="email">Email
              <span id="badgeEmail" class="badge-auto" style="display:none">auto</span>
            </label>
            <input id="email" class="input" type="email" name="email"
                   placeholder="jane@acme.com" autocomplete="email">
          </div>

          <div class="field col-12">
            <label class="label" for="address">Address
              <span id="badgeAddress" class="badge-auto" style="display:none">auto</span>
            </label>
            <input id="address" class="input" type="text" name="address"
                   placeholder="123 Commerce Dr, Indianapolis IN" autocomplete="street-address">
          </div>

          <div class="field col-12">
            <label class="label" for="notes">Notes</label>
            <textarea id="notes" class="textarea" name="notes" rows="4"
                      placeholder="Left voicemailâ€¦"></textarea>
          </div>
        </div>
      </form>
    </div>

    <div class="foot">
      <button class="btn" type="button" onclick="closeModal()">Cancel</button>
      <button class="btn primary" form="newcall-form" type="submit">Add Call</button>
    </div>
  </div>
</div>

  <script>
    // ===== Month accordion with persistence =====
    const closedKey = 'cc_closedMonths';
    function getClosedSet(){ try{ return new Set(JSON.parse(localStorage.getItem(closedKey) || '[]')); } catch{ return new Set(); } }
    function saveClosedSet(set){ localStorage.setItem(closedKey, JSON.stringify(Array.from(set))); }
    const closed = getClosedSet();

    function setMonthState(monthSlug, open){
      const rows = document.querySelectorAll(`.month-${monthSlug}`);
      rows.forEach(r => r.style.display = open ? 'table-row' : 'none');
      const head = document.getElementById(`mhead-${monthSlug}`);
      if (head){
        const chev = head.querySelector('.chev');
        if (chev) chev.textContent = open ? 'â–¾' : 'â–¸';
      }
      if (!open) closed.add(monthSlug); else closed.delete(monthSlug);
      saveClosedSet(closed);
    }

    // initialize accordions + counts
    document.querySelectorAll('.month-header').forEach(h=>{
      const month = h.dataset.month;
      const slug = month.replace(/\s/g,'-');
      const count = document.querySelectorAll(`.month-${slug}`).length;
      const badge = h.querySelector('.mh-count');
      if (badge){ badge.textContent = `Â· ${count}`; }
      const open = !closed.has(slug);
      setMonthState(slug, open);
      h.addEventListener('click', ()=> {
        const firstRow = document.querySelector(`.month-${slug}`);
        const nowOpen = firstRow && firstRow.style.display !== 'none';
        setMonthState(slug, !nowOpen);
      }, {passive:true});
    });

    // ===== Live filter (search just above Past Calls) =====
    const input = document.getElementById('callSearch');
    const clearBtn = document.getElementById('clearSearch');
    const matchCount = document.getElementById('matchCount');
    const allRows = Array.from(document.querySelectorAll('tbody tr.call-row'));

    function expandAllMonths(){
      document.querySelectorAll('.month-header').forEach(h=>{
        const slug = h.dataset.month.replace(/\s/g,'-');
        setMonthState(slug, true);
      });
    }

    function filterCalls(){
      const q = (input.value || '').trim().toLowerCase();
      let matches = 0;
      if (q) expandAllMonths();
      allRows.forEach(row => {
        const hay = ((row.dataset.company||'')+' '+(row.dataset.contact||'')+' '+(row.dataset.email||'')+' '+(row.dataset.phone||'')+' '+(row.dataset.address||'')).toLowerCase();
        const show = !q || hay.includes(q);
        row.style.display = show ? 'table-row' : 'none';
        if (show) matches++;
      });
      matchCount.textContent = q ? `${matches} match${matches===1?'':'es'}` : '';
    }
    input.addEventListener('input', filterCalls, {passive:true});
    input.addEventListener('keydown', e=>{ if (e.key === 'Enter') e.preventDefault(); });
    clearBtn.addEventListener('click', ()=>{ input.value=''; filterCalls(); input.focus(); });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/sw.js').catch(()=>{});
    }
  </script>

  <!-- QR decoder (first try) -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <!-- Tesseract.js (OCR fallback) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
/* ===================== QR FIRST, THEN OCR (email-domain = company, single phone) ===================== */
const scanBtn = document.getElementById('scanBtn');
const fileInput = document.getElementById('cardInput');
const previewWrap = document.getElementById('scanPreview');
const previewImg = document.getElementById('cardPreview');
const scanProgress = document.getElementById('scanProgress');
const scanHints = document.getElementById('scanHints');

const fCompany = document.getElementById('company');
const fName    = document.getElementById('contact_name');
const fEmail   = document.getElementById('email');
const fPhone   = document.getElementById('phone');
const fAddr    = document.getElementById('address');

const bCompany = document.getElementById('badgeCompany');
const bName    = document.getElementById('badgeName');
const bEmail   = document.getElementById('badgeEmail');
const bPhone   = document.getElementById('badgePhone');
const bAddr    = document.getElementById('badgeAddress');
const showBadge = (el, on) => { if (el) el.style.display = on ? '' : 'none'; };

if (scanBtn && fileInput){
  scanBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', handleImage);
}

async function handleImage(){
  const file = fileInput.files && fileInput.files[0];
  if (!file) return;

  const objectUrl = URL.createObjectURL(file);
  previewImg.src = objectUrl;
  previewWrap.style.display = '';
  scanProgress.textContent = 'Scanning for QRâ€¦';
  scanHints.textContent = '';

  const dataUrl = await downscaleImage(file, 1600);

  // 1) Try QR first
  const qr = await decodeQR(dataUrl);
  if (qr && qr.data){
    const parsed = parseQRPayload(qr.data);
    applyParsed(parsed, /*source*/'QR');
    URL.revokeObjectURL(objectUrl);
    return;
  }

  // 2) OCR fallback
  scanProgress.textContent = 'No QR. Running OCRâ€¦';
  const rotated = await autoRotate(dataUrl);
  const prepped = await lightPreprocess(rotated);
  await runOCR(prepped);

  URL.revokeObjectURL(objectUrl);
}

/* ---------- image helpers ---------- */
function downscaleImage(file, maxW){
  return new Promise((resolve,reject)=>{
    const img = new Image(); let u='';
    img.onload=()=>{
      const r = Math.min(1, maxW/img.width);
      const w = Math.round(img.width*r), h = Math.round(img.height*r);
      const c = document.createElement('canvas'); c.width=w; c.height=h;
      c.getContext('2d').drawImage(img,0,0,w,h);
      URL.revokeObjectURL(u);
      resolve(c.toDataURL('image/jpeg', .92));
    };
    img.onerror=reject;
    u = URL.createObjectURL(file);
    img.src = u;
  });
}

async function decodeQR(dataUrl){
  const img = await loadImage(dataUrl);
  const c = document.createElement('canvas'); c.width = img.width; c.height = img.height;
  const ctx = c.getContext('2d'); ctx.drawImage(img,0,0);
  const {data, width, height} = ctx.getImageData(0,0,c.width,c.height);
  return jsQR(data, width, height, { inversionAttempts: 'attemptBoth' });
}

function loadImage(src){
  return new Promise((resolve,reject)=>{
    const i = new Image(); i.onload=()=>resolve(i); i.onerror=reject; i.src=src;
  });
}

async function autoRotate(dataUrl){
  try{
    const det = await Tesseract.detect(dataUrl);
    const deg = det?.data?.orientation?.deg || 0;
    if (!deg) return dataUrl;
    const img = await loadImage(dataUrl);
    const rad = deg * Math.PI/180, s=Math.abs(Math.sin(rad)), c=Math.abs(Math.cos(rad));
    const w=img.width,h=img.height, W=Math.round(w*c+h*s), H=Math.round(w*s+h*c);
    const cnv = document.createElement('canvas'); cnv.width=W; cnv.height=H;
    const ctx = cnv.getContext('2d'); ctx.translate(W/2,H/2); ctx.rotate(rad);
    ctx.drawImage(img,-w/2,-h/2);
    return cnv.toDataURL('image/jpeg', .92);
  }catch{ return dataUrl; }
}

// light grayscale preprocessing (keeps shapes; aggressive binarize can hurt)
async function lightPreprocess(dataUrl){
  const img = await loadImage(dataUrl);
  const c = document.createElement('canvas'); c.width=img.width; c.height=img.height;
  const ctx = c.getContext('2d'); ctx.drawImage(img,0,0);
  const id = ctx.getImageData(0,0,c.width,c.height);
  const d = id.data;
  for (let i=0;i<d.length;i+=4){
    const y = 0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2];
    d[i]=d[i+1]=d[i+2]= y;
  }
  ctx.putImageData(id,0,0);
  return c.toDataURL('image/png', 1);
}

/* ---------- company from email ---------- */
const COMMON_FREE = ['gmail','yahoo','outlook','hotmail','icloud','aol','proton','msn','live','me','gmx','yandex','zoho'];
const COMMON_SUBS = ['mail','email','mx','app','apps','portal','login','id','auth'];
function companyFromEmail(email){
  const dom = (email.split('@')[1]||'').toLowerCase();
  if (!dom) return '';
  let labels = dom.split('.');
  // handle co.uk / com.au style
  if (labels.length>=3 && labels.at(-1).length===2 && ['co','com','org','net'].includes(labels.at(-2))){
    labels = labels.slice(0,-2);
  }else{
    labels = labels.slice(0,-1); // drop TLD
  }
  // drop common subdomains
  while (labels.length>1 && COMMON_SUBS.includes(labels[0])) labels.shift();
  const base = labels.at(-1) || '';
  if (!base || COMMON_FREE.includes(base)) return '';
  return titleCase(base.replace(/[-_]/g,' '));
}

/* ---------- name from email local part ---------- */
function nameFromEmailLocal(local){
  if (!local) return '';
  const parts = local.split(/[._-]+/).filter(Boolean);
  if (parts.length>=2){
    return parts.map(titleCaseToken).join(' ');
  }
  // single token (e.g., jsmith, johns)
  const t = local.replace(/\d+/g,'');
  const m = t.match(/^([a-z])([a-z]{2,})$/i); // jsmith -> J Smith
  if (m) return `${m[1].toUpperCase()} ${titleCase(m[2])}`;
  return titleCase(t);
}

/* ---------- phone helpers (single primary) ---------- */
function extractPhones(raw){
  // labeled preferred, skip fax
  const labeled = Array.from(raw.matchAll(/(?:mobile|cell|direct|main|m:|c:|d:)\s*[:\-]?\s*(\+?\d[\d\s().-]{7,}\d)/ig))
                       .map(m=>m[1]);
  const all = Array.from(raw.matchAll(/(?:\+?\d[\d\s().-]{7,}\d)/g)).map(m=>m[0]);
  let nums = (labeled.length? labeled: all).filter(s=>!/fax/i.test(s));
  // normalise and unique
  const seen = new Set(); const out=[];
  nums.forEach(n=>{
    const k = n.replace(/[^\d+]/g,'');
    if (k.length>=10 && !seen.has(k)){ seen.add(k); out.push(n); }
  });
  return out;
}
function formatPhone(s){
  const digits = s.replace(/[^\d+]/g,'');
  const m = digits.match(/^\+?1?(\d{10})(?:\D*(\d{1,5}))?$/);
  if (m){
    const base = `(${m[1].slice(0,3)}) ${m[1].slice(3,6)}-${m[1].slice(6)}`;
    return m[2] ? `${base} x${m[2]}` : base;
  }
  return s.trim();
}

/* ---------- address extraction ---------- */
function extractAddress(lines){
  const cszRx = /^[A-Za-z .'-]+,\s*[A-Z]{2}\s*\d{5}(?:-\d{4})?$/; // City, ST 12345
  const streetRx = /^\d{1,6}\s+[A-Za-z0-9.\- ]+\b(?:St|Street|Rd|Road|Ave|Avenue|Blvd|Drive|Dr|Ln|Lane|Way|Ct|Court|Pkwy|Parkway|Cir|Circle|Hwy|Highway)\b\.?/i;
  const suiteRx = /\b(Suite|Ste\.?|Unit|#)\s*\w+/i;

  // try "Address:" label first
  const addrLbl = lines.findIndex(l=>/^address[:\s]/i.test(l));
  if (addrLbl>=0){
    let chunk = lines.slice(addrLbl+1, addrLbl+4);
    const street = chunk.find(l=>streetRx.test(l)) || '';
    const csz = chunk.find(l=>cszRx.test(l)) || '';
    const suite = chunk.find(l=>suiteRx.test(l)) || '';
    const a = [street, suite, csz].filter(Boolean).join(', ');
    if (a) return a;
  }

  // City, ST ZIP then street above
  const cidx = lines.findIndex(l=>cszRx.test(l));
  if (cidx>=0){
    let street=''; for (let i=cidx-1;i>=Math.max(0,cidx-3);i--){ if (streetRx.test(lines[i])){ street=lines[i]; break; } }
    const suite = lines[cidx-1] && suiteRx.test(lines[cidx-1]) ? lines[cidx-1] : '';
    return [street, suite, lines[cidx]].filter(Boolean).join(', ');
  }

  // fallback: first plausible street + next two lines
  const sIdx = lines.findIndex(l=>streetRx.test(l));
  if (sIdx>=0){
    const vs=[lines[sIdx]];
    if (lines[sIdx+1]) vs.push(lines[sIdx+1]);
    if (lines[sIdx+2]) vs.push(lines[sIdx+2]);
    return vs.join(', ');
  }
  return '';
}

/* ---------- QR payload parsing ---------- */
function parseQRPayload(s){
  const values = {company:'', name:'', email:'', phone:'', address:''};
  let source = 'QR';

  if (/^BEGIN:VCARD/i.test(s)){
    const lines = s.split(/\r?\n/);
    for (const line of lines){
      const [k, ...rest] = line.split(':');
      const val = rest.join(':').trim();
      if (!val) continue;
      const key = (k||'').toUpperCase();

      if (key.startsWith('FN'))       values.name = values.name || val;
      else if (key.startsWith('N:'))  values.name = values.name || val.split(';').filter(Boolean).join(' ');
      else if (key.startsWith('ORG')) values.company = values.company || val;
      else if (key.startsWith('EMAIL')) values.email = values.email || val;
      else if (key.startsWith('TEL'))   values.phone = values.phone || val;
      else if (key.startsWith('ADR')){
        const parts = val.split(';'); // PO;EXT;STREET;CITY;REGION;POSTAL;COUNTRY
        const street = parts[2]||'', city=parts[3]||'', region=parts[4]||'', postal=parts[5]||'', country=parts[6]||'';
        const addr = [street, city, region && postal ? `${region} ${postal}` : region||postal, country].filter(Boolean).join(', ');
        if (addr) values.address = values.address || addr;
      }
    }
  } else if (/^MECARD:/i.test(s)){
    const body = s.replace(/^MECARD:/i,'').replace(/;$/, '');
    for (const part of body.split(';')){
      const [k,v] = part.split(':'); if (!v) continue;
      const key = k.toUpperCase();
      if (key === 'N') values.name = values.name || v.replace(/,/g,' ');
      else if (key === 'TEL') values.phone = values.phone || v;
      else if (key === 'EMAIL') values.email = values.email || v;
      else if (key === 'ORG') values.company = values.company || v;
      else if (key === 'ADR') values.address = values.address || v;
    }
  } else if (/^https?:\/\//i.test(s)){
    try{
      const u = new URL(s);
      values.email = values.email || u.searchParams.get('email') || u.searchParams.get('e') || '';
      values.name  = values.name  || u.searchParams.get('name')  || u.searchParams.get('n') || '';
      values.phone = values.phone || u.searchParams.get('tel')   || u.searchParams.get('phone') || '';
      values.company = values.company || u.searchParams.get('org') || u.searchParams.get('company') || '';
      values.address = values.address || u.searchParams.get('addr') || u.searchParams.get('address') || '';
    }catch{}
  }

  // Post-process: enforce company from email domain if present
  if (values.email){
    const forcedCo = companyFromEmail(values.email);
    if (forcedCo) values.company = forcedCo;
    // Improve name from email if empty
    if (!values.name){
      const local = values.email.split('@')[0]||'';
      values.name = nameFromEmailLocal(local);
    }
  }

  // Phone: keep only one primary
  if (values.phone){
    values.phone = formatPhone(values.phone);
  }

  return {values, source};
}

/* ---------- OCR fallback (single primary phone, company from email) ---------- */
async function runOCR(dataUrl){
  try{
    const worker = await Tesseract.createWorker('eng', 1, {
      logger: m => { if (m.status==='recognizing text'){ scanProgress.textContent = `OCRâ€¦ ${(m.progress*100|0)}%`; } }
    });
    await worker.setParameters({ tessedit_pageseg_mode: '6', user_defined_dpi: '300' });
    const { data: { text } } = await worker.recognize(dataUrl);
    await worker.terminate();

    const parsed = parseFromText(text||'');
    applyParsed(parsed, 'OCR');
  }catch(e){
    console.error(e);
    scanProgress.textContent = 'Scan failed. You can still type fields.';
    scanHints.textContent = 'Tip: bright light, flat card, fill the frame.';
  }
}

function parseFromText(raw){
  const lines = (raw||'').split('\n').map(l=>l.trim()).filter(Boolean);
  const values = {company:'', name:'', email:'', phone:'', address:''};

  // EMAIL
  const e = raw.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
  if (e) values.email = e[0];

  // PHONE (single best)
  const phones = extractPhones(raw);
  if (phones.length) values.phone = formatPhone(phones[0]);

  // COMPANY: ALWAYS from email domain if possible (per your request)
  if (values.email){
    const forced = companyFromEmail(values.email);
    if (forced) values.company = forced;
  } else {
    // fallback: ALL CAPS or org suffix near top
    const orgIdx = lines.findIndex(l => /\b(LLC|INC\.?|CORP\.?|CO\.?|COMPANY|INDUSTRIES|HOLDINGS|GROUP|LTD|LLP)\b/i.test(l));
    if (orgIdx>=0) values.company = cleanCompany(lines[orgIdx]);
    if (!values.company){
      const upper = lines.find(l => l.length>3 && l===l.toUpperCase() && !/\d|@|http|www/i.test(l));
      if (upper) values.company = cleanCompany(upper);
    }
  }

  // NAME
  if (values.email && !values.name){
    const local = values.email.split('@')[0]||'';
    values.name = nameFromEmailLocal(local);
  }
  if (!values.name){
    const TITLE = /owner|founder|ceo|cfo|coo|cto|vp|manager|director|sales|account|engineer|operations|marketing|service|technician|advisor|consultant/i;
    const nameIdx = lines.findIndex(l => /^[A-Z][a-z]+(?:[-\s'][A-Z][a-z]+)+$/.test(l) && !TITLE.test(l));
    if (nameIdx>=0) values.name = lines[nameIdx];
  }

  // ADDRESS
  const address = extractAddress(lines);
  if (address) values.address = address;

  return {values, source:'OCR'};
}

/* ---------- apply to form ---------- */
function applyParsed(parsed, source){
  const v = parsed.values || {};
  if (v.company && !fCompany.value){ fCompany.value = v.company; showBadge(bCompany, true); }
  if (v.name    && !fName.value){    fName.value    = v.name;    showBadge(bName, true); }
  if (v.email   && !fEmail.value){   fEmail.value   = v.email;   showBadge(bEmail, true); }
  if (v.phone   && !fPhone.value){   fPhone.value   = v.phone;   showBadge(bPhone, true); }
  if (v.address && !fAddr.value){    fAddr.value    = v.address; showBadge(bAddr, true); }

  scanProgress.textContent = `${source} parsed. Review & save.`;
  const hints = [];
  if (v.company) hints.push('company'); if (v.name) hints.push('name');
  if (v.email) hints.push('email'); if (v.phone) hints.push('phone'); if (v.address) hints.push('address');
  scanHints.textContent = `Source: ${source}${hints.length? ' ('+hints.join(', ')+')' : ''}`;

  // Scroll form into view on mobile
  const form = document.getElementById('newcall-form');
  if (form){ form.scrollIntoView({behavior:'smooth', block:'start'}); }
}

/* ---------- small string helpers ---------- */
function cleanCompany(s){ return s.replace(/\s{2,}/g,' ').replace(/\s+[|Â·\-â€“]\s+.*$/, '').trim(); }
function titleCaseToken(w){ return w ? w[0].toUpperCase() + w.slice(1).toLowerCase() : w; }
function titleCase(s){ return s.split(' ').map(titleCaseToken).join(' '); }
</script>
</body>
</html>
