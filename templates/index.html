<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cold Call Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="theme-color" content="#cc0000" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}" />
  <script>
    function openModal(){ document.getElementById('callModal').classList.add('open'); }
    function closeModal(){ document.getElementById('callModal').classList.remove('open'); }
  </script>
</head>
<body>

  <!-- Header -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand-wrap">
        <img src="{{ url_for('static', filename='tynan_logo.png') }}" class="logo-img" alt="Tynan" />
        <div class="brand-title">Cold Call Tracker</div>
        <img src="{{ url_for('static', filename='heli_logo.png') }}" class="logo-img" alt="HELI" />
      </div>
      <nav class="topnav">
        <a href="/">Dashboard</a>
        <a href="/schedule">Schedule</a>
        <a href="/logout">Logout</a>
      </nav>
    </div>
  </header>

  <div class="shell">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sb-title">MENU</div>
      <div class="sb-nav">
        <a class="sb-btn active" href="/">Dashboard</a>
        <button class="sb-btn" type="button" onclick="openModal()">ðŸ“ž Log New Call</button>
        <a class="sb-btn" href="/schedule">ðŸ“… Schedule</a>
        <a class="sb-btn" href="/logout">Logout</a>
      </div>
      <div class="sb-legend">
        <div class="legend-item"><span class="legend-dot red"></span> Follow-up overdue</div>
        <div class="legend-item"><span class="legend-dot gray"></span> Due today</div>
      </div>
      <hr class="mt-12 mb-8">
      <div class="subtle">Welcome, <strong>{{ user }}</strong></div>
    </aside>

    <!-- Main content (scrolls naturally) -->
    <main>

      <!-- Reminders -->
      <section class="panel">
        <h2 class="section-title">Reminders</h2>
        <div class="reminders">
          {% if reminders %}
            {% for r in reminders %}
              <div class="rem-card">
                <h3>{{ r['company'] }}</h3>
                <div class="k">Last contacted: {{ r['days_ago'] }} days ago</div>
                <div class="k">Suggested Action: <strong>{{ r['action'] }}</strong></div>
              </div>
            {% endfor %}
          {% else %}
            <div class="rem-card">
              <h3>Nothing due today</h3>
              <div class="k">You're all caught up.</div>
            </div>
          {% endif %}
          <div class="rem-card red">
            <h3>Log a New Cold Call</h3>
            <button class="cta" type="button" onclick="openModal()">Open form</button>
          </div>
        </div>
      </section>

      <!-- Past Cold Calls -->
      <section class="panel mt-16">
        <div class="section-head">
          <h2 class="section-title">Past Cold Calls</h2>
          <!-- Search bar sits directly above the table -->
          <div class="toolbar" aria-label="Filter past calls" style="margin-top:8px">
            <input id="callSearch" class="input searchbar" type="search" inputmode="search"
                   enterkeyhint="search" autocapitalize="off" autocomplete="off"
                   placeholder="Search company, contact, email, phoneâ€¦" />
            <button class="btn ghost" type="button" id="clearSearch">Clear</button>
            <div class="right subtle" id="matchCount" aria-live="polite"></div>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Company</th>
                <th>Contact Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Address</th>
                <th>Notes</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="callsBody">
              {% for month, calls in calls_by_month.items() %}
                <tr class="month-header touch-target" data-month="{{ month }}" id="mhead-{{ month.replace(' ', '-') }}">
                  <td colspan="7" style="font-weight:800">
                    <span class="chev">â–¸</span>
                    <span class="mh-label">{{ month }}</span>
                    <span class="mh-count" aria-hidden="true"></span>
                  </td>
                </tr>
                {% for call in calls %}
                  <tr
                    class="call-row month-{{ month.replace(' ', '-') }}"
                    data-month-key="{{ month.replace(' ', '-') }}"
                    data-company="{{ (call['company'] or '')|e }}"
                    data-contact="{{ (call['contact_name'] or '')|e }}"
                    data-email="{{ (call['email'] or '')|e }}"
                    data-phone="{{ (call['phone'] or '')|e }}"
                    data-address="{{ (call['address'] or '')|e }}"
                    data-date="{{ call['date_called'] }}"
                    style="display:none;"
                  >
                    <td data-label="Company"><strong>{{ call['company'] }}</strong></td>
                    <td data-label="Contact Name">{{ call['contact_name'] or 'â€”' }}</td>
                    <td data-label="Email">{{ call['email'] or 'â€”' }}</td>
                    <td data-label="Phone">{{ call['phone'] or 'â€”' }}</td>
                    <td data-label="Address">{{ call['address'] or 'â€”' }}</td>
                    <td data-label="Notes" style="white-space:pre-wrap">{{ call['notes'] or 'â€”' }}</td>
                    <td data-label="Actions">
                      <div class="row-actions">
                        <a href="/edit_call/{{ call['id'] }}" class="btn sm ghost">Edit</a>
                        <a href="/delete_call/{{ call['id'] }}" class="btn sm primary" onclick="return confirm('Are you sure?')">Delete</a>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

<!-- Add Call Modal (with Business Card Scan) -->
<div class="modal" id="callModal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="newCallTitle">
    <div class="head">
      <h2 id="newCallTitle" class="mt-0 mb-0">Log a New Cold Call</h2>
      <button class="btn icon ghost" type="button" aria-label="Close" onclick="closeModal()">âœ•</button>
    </div>

    <div class="body">
      <!-- SCAN CONTROLS -->
      <div class="scan-row">
        <input id="cardInput" type="file" accept="image/*" capture="environment" style="display:none" />
        <button class="scan-btn" type="button" id="scanBtn">ðŸ“· Scan business card</button>
        <span class="scan-note">Auto-fill company, name, email, phone from a photo.</span>
      </div>
      <div id="scanPreview" class="scan-preview" style="display:none">
        <img id="cardPreview" alt="Business card preview">
        <div>
          <div class="scan-progress" id="scanProgress">Scanningâ€¦</div>
          <div class="subtle" id="scanHints" style="margin-top:4px"></div>
        </div>
      </div>

      <!-- FORM -->
      <form id="newcall-form" action="/add" method="POST" class="form form-vertical" autocomplete="on">
        <div class="form-grid">
          <div class="field col-6">
            <label class="label" for="company">Company <span class="subtle">(required)</span>
              <span id="badgeCompany" class="badge-auto" style="display:none">auto</span>
            </label>
            <input id="company" class="input" type="text" name="company" required
                   placeholder="Acme Manufacturing" autocomplete="organization">
          </div>

          <div class="field col-6">
            <label class="label" for="contact_name">Contact Name
              <span id="badgeName" class="badge-auto" style="display:none">auto</span>
            </label>
            <input id="contact_name" class="input" type="text" name="contact_name"
                   placeholder="Jane Smith" autocomplete="name">
          </div>

          <div class="field col-6">
            <label class="label" for="phone">Phone
              <span id="badgePhone" class="badge-auto" style="display:none">auto</span>
            </label>
            <input id="phone" class="input" type="tel" inputmode="tel" name="phone"
                   placeholder="(317) 555-0199" autocomplete="tel">
          </div>

          <div class="field col-6">
            <label class="label" for="email">Email
              <span id="badgeEmail" class="badge-auto" style="display:none">auto</span>
            </label>
            <input id="email" class="input" type="email" name="email"
                   placeholder="jane@acme.com" autocomplete="email">
          </div>

          <div class="field col-12">
            <label class="label" for="address">Address
              <span id="badgeAddress" class="badge-auto" style="display:none">auto</span>
            </label>
            <input id="address" class="input" type="text" name="address"
                   placeholder="123 Commerce Dr, Indianapolis IN" autocomplete="street-address">
          </div>

          <div class="field col-12">
            <label class="label" for="notes">Notes</label>
            <textarea id="notes" class="textarea" name="notes" rows="4"
                      placeholder="Left voicemailâ€¦"></textarea>
          </div>
        </div>
      </form>
    </div>

    <div class="foot">
      <button class="btn" type="button" onclick="closeModal()">Cancel</button>
      <button class="btn primary" form="newcall-form" type="submit">Add Call</button>
    </div>
  </div>
</div>

  <script>
    // ===== Month accordion with persistence =====
    const closedKey = 'cc_closedMonths';
    function getClosedSet(){ try{ return new Set(JSON.parse(localStorage.getItem(closedKey) || '[]')); } catch{ return new Set(); } }
    function saveClosedSet(set){ localStorage.setItem(closedKey, JSON.stringify(Array.from(set))); }
    const closed = getClosedSet();

    function setMonthState(monthSlug, open){
      const rows = document.querySelectorAll(`.month-${monthSlug}`);
      rows.forEach(r => r.style.display = open ? 'table-row' : 'none');
      const head = document.getElementById(`mhead-${monthSlug}`);
      if (head){
        const chev = head.querySelector('.chev');
        if (chev) chev.textContent = open ? 'â–¾' : 'â–¸';
      }
      if (!open) closed.add(monthSlug); else closed.delete(monthSlug);
      saveClosedSet(closed);
    }

    // initialize accordions + counts
    document.querySelectorAll('.month-header').forEach(h=>{
      const month = h.dataset.month;
      const slug = month.replace(/\s/g,'-');
      const count = document.querySelectorAll(`.month-${slug}`).length;
      const badge = h.querySelector('.mh-count');
      if (badge){ badge.textContent = `Â· ${count}`; }
      const open = !closed.has(slug);
      setMonthState(slug, open);
      h.addEventListener('click', ()=> {
        const firstRow = document.querySelector(`.month-${slug}`);
        const nowOpen = firstRow && firstRow.style.display !== 'none';
        setMonthState(slug, !nowOpen);
      }, {passive:true});
    });

    // ===== Live filter (search just above Past Calls) =====
    const input = document.getElementById('callSearch');
    const clearBtn = document.getElementById('clearSearch');
    const matchCount = document.getElementById('matchCount');
    const allRows = Array.from(document.querySelectorAll('tbody tr.call-row'));

    function expandAllMonths(){
      document.querySelectorAll('.month-header').forEach(h=>{
        const slug = h.dataset.month.replace(/\s/g,'-');
        setMonthState(slug, true);
      });
    }

    function filterCalls(){
      const q = (input.value || '').trim().toLowerCase();
      let matches = 0;
      if (q) expandAllMonths();
      allRows.forEach(row => {
        const hay = ((row.dataset.company||'')+' '+(row.dataset.contact||'')+' '+(row.dataset.email||'')+' '+(row.dataset.phone||'')+' '+(row.dataset.address||'')).toLowerCase();
        const show = !q || hay.includes(q);
        row.style.display = show ? 'table-row' : 'none';
        if (show) matches++;
      });
      matchCount.textContent = q ? `${matches} match${matches===1?'':'es'}` : '';
    }
    input.addEventListener('input', filterCalls, {passive:true});
    input.addEventListener('keydown', e=>{ if (e.key === 'Enter') e.preventDefault(); });
    clearBtn.addEventListener('click', ()=>{ input.value=''; filterCalls(); input.focus(); });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/sw.js').catch(()=>{});
    }
  </script>

<!-- Tesseract.js -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
  // ===== Improved business card scan (orientation + preprocessing + smarter parsing) =====

  const scanBtn = document.getElementById('scanBtn');
  const fileInput = document.getElementById('cardInput');
  const previewWrap = document.getElementById('scanPreview');
  const previewImg = document.getElementById('cardPreview');
  const scanProgress = document.getElementById('scanProgress');
  const scanHints = document.getElementById('scanHints');

  const fCompany = document.getElementById('company');
  const fName    = document.getElementById('contact_name');
  const fEmail   = document.getElementById('email');
  const fPhone   = document.getElementById('phone');
  const fAddr    = document.getElementById('address');

  const bCompany = document.getElementById('badgeCompany');
  const bName    = document.getElementById('badgeName');
  const bEmail   = document.getElementById('badgeEmail');
  const bPhone   = document.getElementById('badgePhone');
  const bAddr    = document.getElementById('badgeAddress');

  function showBadge(el, show){ if(el) el.style.display = show ? '' : 'none'; }

  if (scanBtn && fileInput){
    scanBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleImageSelect);
  }

  async function handleImageSelect(){
    const file = fileInput.files && fileInput.files[0];
    if (!file) return;

    const objectUrl = URL.createObjectURL(file);
    previewImg.src = objectUrl;
    previewWrap.style.display = '';
    scanProgress.textContent = 'Scanningâ€¦';
    scanHints.textContent = '';

    // Downscale for speed
    const dataUrl = await downscaleImage(file, 1600);

    // Detect orientation and rotate if needed, then preprocess
    const rotated = await autoRotate(dataUrl);
    const prepped = await preprocessImage(rotated);

    await runOCR(prepped);

    URL.revokeObjectURL(objectUrl);
  }

  function downscaleImage(file, maxW){
    return new Promise((resolve,reject)=>{
      const img = new Image();
      let localURL = '';
      img.onload = ()=>{
        const ratio = Math.min(1, maxW / img.width);
        const w = Math.round(img.width * ratio);
        const h = Math.round(img.height * ratio);
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        URL.revokeObjectURL(localURL);
        resolve(canvas.toDataURL('image/jpeg', 0.9));
      };
      img.onerror = reject;
      localURL = URL.createObjectURL(file);
      img.src = localURL;
    });
  }

  async function autoRotate(dataUrl){
    try{
      const det = await Tesseract.detect(dataUrl);
      const deg = (det && det.data && det.data.orientation && det.data.orientation.deg) || 0;
      if (!deg) return dataUrl;
      return await rotateImage(dataUrl, deg);
    }catch{ return dataUrl; }
  }

  function rotateImage(dataUrl, deg){
    return new Promise((resolve)=>{
      const img = new Image();
      img.onload = ()=>{
        const rad = deg * Math.PI / 180;
        const sin = Math.abs(Math.sin(rad)), cos = Math.abs(Math.cos(rad));
        const w = img.width, h = img.height;
        const newW = Math.round(w*cos + h*sin);
        const newH = Math.round(w*sin + h*cos);
        const canvas = document.createElement('canvas');
        canvas.width = newW; canvas.height = newH;
        const ctx = canvas.getContext('2d');
        ctx.translate(newW/2, newH/2);
        ctx.rotate(rad);
        ctx.drawImage(img, -w/2, -h/2);
        resolve(canvas.toDataURL('image/jpeg', 0.92));
      };
      img.src = dataUrl;
    });
  }

  // Simple image preprocessing: grayscale + contrast + binarize
  function preprocessImage(dataUrl){
    return new Promise((resolve)=>{
      const img = new Image();
      img.onload = ()=>{
        const c = document.createElement('canvas');
        c.width = img.width; c.height = img.height;
        const ctx = c.getContext('2d');
        ctx.drawImage(img, 0, 0);
        const imageData = ctx.getImageData(0,0,c.width,c.height);
        const d = imageData.data;

        // grayscale + light contrast
        for (let i=0;i<d.length;i+=4){
          const r=d[i],g=d[i+1],b=d[i+2];
          let y = 0.299*r + 0.587*g + 0.114*b;
          // contrast 1.2, brightness +5
          y = (y-128)*1.2 + 133;
          d[i]=d[i+1]=d[i+2]=y;
        }
        ctx.putImageData(imageData,0,0);

        // quick binarize by mean threshold (fast & good enough for cards)
        const id2 = ctx.getImageData(0,0,c.width,c.height);
        const p = id2.data;
        let sum=0, n=p.length/4;
        for(let i=0;i<p.length;i+=4) sum += p[i];
        const thr = sum/n; // mean
        for(let i=0;i<p.length;i+=4){
          const v = p[i] > thr ? 255 : 0;
          p[i]=p[i+1]=p[i+2]=v;
        }
        ctx.putImageData(id2,0,0);

        resolve(c.toDataURL('image/png', 1.0));
      };
      img.src = dataUrl;
    });
  }

  async function runOCR(preppedDataUrl){
    try{
      const worker = await Tesseract.createWorker('eng', 1, {
        logger: m => {
          if (m.status === 'recognizing text' && m.progress != null){
            scanProgress.textContent = `Scanningâ€¦ ${(m.progress*100).toFixed(0)}%`;
          }
        }
      });

      // Better defaults for business cards
      await worker.setParameters({
        tessedit_pageseg_mode: '6',  // Assume a single uniform block of text
        user_defined_dpi: '300'
      });

      // First pass (general)
      const { data: { text } } = await worker.recognize(preppedDataUrl);

      // Parse
      let parsed = parseBusinessCard(text || '');

      // If email/phone missing, second pass with whitelist helps reduce OCR confusions
      if (!parsed.email || !parsed.phone){
        await worker.setParameters({
          tessedit_pageseg_mode: '6',
          tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789@._+-()[]{}<>:;/\\|~`!#$%^&*=,?- '
        });
        const { data: { text: text2 } } = await worker.recognize(preppedDataUrl);
        const parsed2 = parseBusinessCard(text2 || '');
        parsed = mergeParsed(parsed, parsed2);
      }

      await worker.terminate();

      scanProgress.textContent = 'Done. Review & save.';
      fillFields(parsed);
      scanHints.innerHTML = (parsed._hints || []).join(' Â· ');

    }catch(err){
      console.error(err);
      scanProgress.textContent = 'Scan failed. You can still type fields manually.';
      scanHints.textContent = 'Tip: Retake the photo in good light, fill the frame, avoid glare.';
    }
  }

  // ===== Smarter parsing =====
  function parseBusinessCard(raw){
    const lines = (raw || '').replace(/\r/g,'').split('\n').map(l=>l.trim()).filter(Boolean);
    const out = { company:'', name:'', email:'', phone:'', address:'', _hints:[] };

    // Email
    const emailMatch = raw.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i);
    if (emailMatch) out.email = emailMatch[0];

    // Phone: prefer labels (mobile/cell) if present
    const phoneCandidates = (raw.match(/(?:mobile|cell|m:|c:)\s*[:\-]?\s*(\+?\d[\d\s().-]{7,}\d)/ig) || [])
      .map(s=>s.replace(/(?:mobile|cell|m:|c:)\s*[:\-]?\s*/i,'').trim());
    if (!phoneCandidates.length){
      const all = raw.match(/(?:\+?\d[\d\s().-]{7,}\d)/g) || [];
      if (all.length) phoneCandidates.push(all[0]);
    }
    if (phoneCandidates.length) out.phone = normalisePhone(phoneCandidates[0]);

    // Company: explicit Inc/LLC/etc or ALL CAPS
    const corpIdx = lines.findIndex(l => /\b(LLC|INC\.?|CORP\.?|CO\.?|COMPANY|INDUSTRIES|HOLDINGS)\b/i.test(l));
    if (corpIdx >= 0) out.company = cleanCompany(lines[corpIdx]);
    if (!out.company){
      const upper = lines.find(l => l.length>2 && l === l.toUpperCase() && !/\d/.test(l));
      if (upper) out.company = cleanCompany(upper);
    }
    if (!out.company && lines[0]) out.company = cleanCompany(lines[0]);

    // Name: proper case with 2+ words
    const nameIdx = lines.findIndex(l => /^[A-Z][a-z]+(?:[-\s'][A-Z][a-z]+)+$/.test(l));
    if (nameIdx >= 0) out.name = lines[nameIdx];

    // Address: street suffix or number + street
    const addrIdx = lines.findIndex(l => /\b(AVE|AVENUE|ST|STREET|RD|ROAD|BLVD|DR|DRIVE|LN|LANE|HWY|PKWY|SUITE|STE|FLOOR|FL|BLDG|UNIT)\b/i.test(l) || /\d{3,}\s+[A-Za-z]/.test(l));
    if (addrIdx >= 0) out.address = lines.slice(addrIdx, addrIdx+2).join(', ');

    // Derive missing pieces from email
    if (out.email){
      if (!out.company){
        const dom = out.email.split('@')[1] || '';
        const base = (dom.split('.')[0] || '').replace(/-/g,' ');
        if (base && base.length>2) out.company = titleCase(base);
      }
      if (!out.name){
        const user = out.email.split('@')[0] || '';
        const parts = user.split(/[._-]+/).filter(p=>p.length>1 && !/^\d+$/.test(p));
        if (parts.length>=2) out.name = parts.map(titleCase).join(' ');
      }
    }

    if (out.email) out._hints.push('email');
    if (out.phone) out._hints.push('phone');
    if (out.name) out._hints.push('name');
    if (out.company) out._hints.push('company');
    if (out.address) out._hints.push('address');

    return out;
  }

  function mergeParsed(a,b){
    return {
      company: a.company || b.company,
      name:    a.name    || b.name,
      email:   a.email   || b.email,
      phone:   a.phone   || b.phone,
      address: a.address || b.address,
      _hints:  Array.from(new Set([...(a._hints||[]), ...(b._hints||[])]))
    };
  }

  function normalisePhone(s){
    const digits = s.replace(/[^\d+]/g,'');
    const m = digits.match(/^\+?1?(\d{10})$/);
    if (m){ return `(${m[1].slice(0,3)}) ${m[1].slice(3,6)}-${m[1].slice(6)}`; }
    return s.trim();
  }
  function cleanCompany(s){
    return s.replace(/\s{2,}/g,' ').replace(/\s+[|Â·\-â€“]\s+.*$/, '').trim();
  }
  function titleCase(w){
    return w.replace(/\b([a-z])/g, m=>m.toUpperCase()).replace(/\bOf\b/g,'of').replace(/\bAnd\b/g,'and');
  }

  function fillFields(p){
    if (p.company && fCompany && !fCompany.value){ fCompany.value = p.company; showBadge(bCompany,true); }
    if (p.name && fName && !fName.value){ fName.value = p.name; showBadge(bName,true); }
    if (p.email && fEmail && !fEmail.value){ fEmail.value = p.email; showBadge(bEmail,true); }
    if (p.phone && fPhone && !fPhone.value){ fPhone.value = p.phone; showBadge(bPhone,true); }
    if (p.address && fAddr && !fAddr.value){ fAddr.value = p.address; showBadge(bAddr,true); }

    const form = document.getElementById('newcall-form');
    if (form){ form.scrollIntoView({behavior:'smooth', block:'start'}); }
  }
</script>
</body>
</html>
