<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cold Call Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="theme-color" content="#cc0000" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}" />
  <script>
    // Month group toggle
    function toggleMonth(month){
      const key = month.replace(/\s/g,'-');
      document.querySelectorAll(`.month-${key}`).forEach(r=>{
        r.style.display = (r.style.display === 'table-row') ? 'none' : 'table-row';
      });
    }
    // Modal controls
    function openModal(){ document.getElementById('callModal').classList.add('open'); }
    function closeModal(){ document.getElementById('callModal').classList.remove('open'); }
  </script>
</head>
<body>

  <!-- Top Bar (trimmed nav) -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand-wrap">
        <img src="{{ url_for('static', filename='tynan_logo.png') }}" class="logo-img" alt="Tynan" />
        <div class="brand-title">Cold Call Tracker</div>
        <img src="{{ url_for('static', filename='heli_logo.png') }}" class="logo-img" alt="HELI" />
      </div>
      <nav class="topnav">
        <a href="/">Dashboard</a>
        <a href="/schedule">Schedule</a>
        <a href="/logout">Logout</a>
      </nav>
    </div>
  </header>

  <!-- Shell layout -->
  <div class="shell">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sb-title">MENU</div>
      <div class="sb-nav">
        <a class="sb-btn active" href="/">Dashboard</a>
        <button class="sb-btn" type="button" onclick="openModal()">üìû Log New Call</button>
        <a class="sb-btn" href="/schedule">üìÖ Schedule</a>
        <a class="sb-btn" href="/logout">Logout</a>
      </div>
      <div class="sb-legend">
        <div class="legend-item"><span class="legend-dot red"></span> Follow-up overdue</div>
        <div class="legend-item"><span class="legend-dot gray"></span> Due today</div>
      </div>
      <hr class="mt-12 mb-8">
      <div class="subtle">Welcome, <strong>{{ user }}</strong></div>
    </aside>

    <!-- Main -->
    <main>
      <!-- Reminders -->
      <section class="panel">
        <h2 class="section-title">Reminders</h2>
        <div class="reminders">
          {% if reminders %}
            {% for reminder in reminders %}
              <div class="rem-card">
                <h3>{{ reminder['company'] }}</h3>
                <div class="k">Last contacted: {{ reminder['days_ago'] }} days ago</div>
                <div class="k">Suggested Action: <strong>{{ reminder['action'] }}</strong></div>
              </div>
            {% endfor %}
          {% else %}
            <div class="rem-card">
              <h3>Nothing due today</h3>
              <div class="k">You're all caught up.</div>
            </div>
          {% endif %}
          <div class="rem-card red">
            <h3>Log a New Cold Call</h3>
            <button class="cta" type="button" onclick="openModal()">Open form</button>
          </div>
        </div>
      </section>

      <!-- Past Cold Calls -->
      <section class="panel mt-16">
        <h2 class="section-title">Past Cold Calls</h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Company</th>
                <th>Contact Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Address</th>
                <th>Notes</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for month, calls in calls_by_month.items() %}
                <tr class="month-header" style="cursor:pointer;background:#171b22" onclick="toggleMonth('{{ month }}')">
                  <td colspan="7" style="font-weight:800">{{ month }}</td>
                </tr>
                {% for call in calls %}
                  <tr class="month-{{ month.replace(' ', '-') }}" style="display:none;">
                    <td>{{ call['company'] }}</td>
                    <td>{{ call['contact_name'] or '‚Äî' }}</td>
                    <td>{{ call['email'] or '‚Äî' }}</td>
                    <td>{{ call['phone'] or '‚Äî' }}</td>
                    <td>{{ call['address'] or '‚Äî' }}</td>
                    <td style="white-space:pre-wrap">{{ call['notes'] or '‚Äî' }}</td>
                    <td>
                      <div class="row-actions">
                        <a href="/edit_call/{{ call['id'] }}" class="btn sm ghost">Edit</a>
                        <a href="/delete_call/{{ call['id'] }}" class="btn sm primary"
                           onclick="return confirm('Are you sure?')">Delete</a>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal: CLEAN Add Cold Call form -->
  <div class="modal" id="callModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="newCallTitle">
      <div class="head">
        <h2 id="newCallTitle" class="mt-0 mb-0">Log a New Cold Call</h2>
        <button class="btn icon ghost" type="button" aria-label="Close" onclick="closeModal()">‚úï</button>
      </div>

      <div class="body">
        <!-- vertical, tidy fields; 2 cols desktop / 1 col mobile -->
        <form id="newcall-form" action="/add" method="POST" class="form form-vertical">
          <div class="form-grid">
            <div class="field col-6">
              <label class="label" for="company">Company <span class="subtle">(required)</span></label>
              <input id="company" class="input" type="text" name="company" required placeholder="Acme Manufacturing">
            </div>
            <div class="field col-6">
              <label class="label" for="contact_name">Contact Name</label>
              <input id="contact_name" class="input" type="text" name="contact_name" placeholder="Jane Smith">
            </div>

            <div class="field col-6">
              <label class="label" for="phone">Phone</label>
              <input id="phone" class="input" type="tel" inputmode="tel" name="phone" placeholder="(317) 555-0199">
            </div>
            <div class="field col-6">
              <label class="label" for="email">Email</label>
              <input id="email" class="input" type="email" name="email" placeholder="jane@acme.com">
            </div>

            <div class="field col-12">
              <label class="label" for="address">Address</label>
              <input id="address" class="input" type="text" name="address" placeholder="123 Commerce Dr, Indianapolis IN">
            </div>

            <div class="field col-12">
              <label class="label" for="notes">Notes</label>
              <textarea id="notes" class="textarea" name="notes" rows="4" placeholder="Left voicemail‚Ä¶"></textarea>
            </div>
          </div>
        </form>
      </div>

      <div class="foot">
        <button class="btn" type="button" onclick="closeModal()">Cancel</button>
        <button class="btn primary" form="newcall-form" type="submit">Add Call</button>
      </div>
    </div>
  </div>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/sw.js')
        .then(() => console.log('‚úÖ Service Worker Registered'))
        .catch(err => console.error('‚ùå Service Worker Error:', err));
    }
  </script>
</body>
</html>
