<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Schedule ‚Äî Cold Call Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="theme-color" content="#cc0000" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}" />

  <!-- page-scoped polish -->
  <style>
    .cal-scroll{overflow-x:auto;padding-bottom:6px}
    .cal-inner{min-width:920px}
    @media (max-width:900px){.cal-inner{min-width:780px}}

    .weekday-bar{
      display:grid;grid-template-columns:repeat(7, minmax(0,1fr));gap:1px;background:var(--border);
      border-bottom:1px solid var(--border)
    }
    .weekday{
      background:linear-gradient(180deg,#171b22,#13171d);
      padding:10px 8px;text-align:center;color:#e6e8ed;font-weight:800;font-size:.92rem
    }

    .calendar.panel{padding:0} /* use head + grid only */
    .calendar .cal-head{
      display:grid; grid-template-columns:auto 1fr auto; align-items:center;
      gap:10px; padding:12px 14px; border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,#14181f,#11151b)
    }
    .calendar .cal-head h3{margin:0; text-align:center}

    .calendar-grid{
      display:grid; gap:1px; background:var(--border);
      grid-template-columns:repeat(7, minmax(0, 1fr)); /* reinforced */
    }
    .day{
      background:linear-gradient(180deg,#11161c,#0f1419);
      padding:10px 8px; border:1px solid rgba(255,255,255,.02); border-radius:4px;
      display:flex; flex-direction:column; gap:6px; transition:background .15s ease
    }
    .day:hover{background:#141a22}
    .day .dnum{
      position:absolute; top:6px; right:6px; font-weight:900; font-size:.8rem; color:#cfd5dd;
      padding:2px 8px; border-radius:999px; background:#0e1319; border:1px solid #1f2631
    }
    .day.today{outline:2px solid var(--accent); outline-offset:-2px}
    .day.today .dnum{color:#fff; background:var(--accent); border-color:var(--accent)}

    .event.call{background:rgba(204,0,0,.16);border:1px solid rgba(204,0,0,.28);color:#ffd4d4;border-radius:10px;padding:6px 8px;font-weight:800;font-size:.86rem}
    .event.visit{background:rgba(31,157,85,.18);border:1px solid rgba(31,157,85,.3);color:#c9f1da;border-radius:10px;padding:6px 8px;font-weight:800;font-size:.86rem}
    .event.demo{background:rgba(192,142,0,.16);border:1px solid rgba(192,142,0,.3);color:#ffefb5;border-radius:10px;padding:6px 8px;font-weight:800;font-size:.86rem}

    /* modal list spacing */
    #dayBody .event{margin:6px 0}
  </style>
</head>
<body>

  <!-- Clean header (uses updated styles.css rules) -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand-wrap">
        <img src="{{ url_for('static', filename='tynan_logo.png') }}" class="logo-img" alt="Tynan" />
        <div class="brand-title">Cold Call Tracker</div>
        <img src="{{ url_for('static', filename='heli_logo.png') }}" class="logo-img" alt="HELI" />
      </div>
      <nav class="topnav">
        <a href="/">Dashboard</a>
        <a href="/schedule">Schedule</a>
        <a href="/logout">Logout</a>
      </nav>
    </div>
  </header>

  <div class="shell">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sb-title">MENU</div>
      <div class="sb-nav">
        <a class="sb-btn" href="/">Dashboard</a>
        <a class="sb-btn active" href="/schedule">üìÖ Schedule</a>
        <button class="sb-btn" type="button" onclick="document.getElementById('newEventModal').classList.add('open')">‚ûï Add Event</button>
        <a class="sb-btn" href="/logout">Logout</a>
      </div>
      <div class="sb-legend">
        <div class="legend-item"><span class="legend-dot red"></span> Follow-up overdue</div>
        <div class="legend-item"><span class="legend-dot gray"></span> Due today</div>
      </div>
    </aside>

    <!-- Calendar -->
    <main>
      <section class="calendar panel">
        <div class="cal-head">
          <div class="btn-row"><button class="btn" id="prevBtn" type="button">‚Üê Prev</button></div>
          <h3 id="calTitle"></h3>
          <div class="btn-row">
            <button class="btn" id="todayBtn" type="button">Today</button>
            <button class="btn" id="nextBtn" type="button">Next ‚Üí</button>
          </div>
        </div>

        <div class="cal-scroll">
          <div class="cal-inner">
            <div class="weekday-bar">
              <div class="weekday">Sun</div><div class="weekday">Mon</div><div class="weekday">Tue</div>
              <div class="weekday">Wed</div><div class="weekday">Thu</div><div class="weekday">Fri</div><div class="weekday">Sat</div>
            </div>
            <div class="calendar-grid" id="calGrid" data-year="{{ year }}" data-month="{{ month }}"></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Day modal -->
  <div class="modal" id="dayModal" aria-hidden="true">
    <div class="dialog">
      <div class="head">
        <h2 class="mt-0 mb-0" id="dayTitle">Day</h2>
        <button class="btn icon ghost" type="button" onclick="document.getElementById('dayModal').classList.remove('open')">‚úï</button>
      </div>
      <div class="body" id="dayBody"></div>
      <div class="foot">
        <button class="btn" type="button" onclick="document.getElementById('dayModal').classList.remove('open')">Close</button>
      </div>
    </div>
  </div>

  <!-- Add Event modal -->
  <div class="modal" id="newEventModal" aria-hidden="true">
    <div class="dialog">
      <div class="head">
        <h2 class="mt-0 mb-0">Add Event</h2>
        <button class="btn icon ghost" type="button" onclick="document.getElementById('newEventModal').classList.remove('open')">‚úï</button>
      </div>
      <form id="add-event-form" action="/add_event" method="POST" class="form form-vertical">
        <div class="body">
          <div class="form-grid">
            <div class="field col-6">
              <label class="label" for="evt_date">Date</label>
              <input id="evt_date" class="input" type="date" name="date" required>
            </div>
            <div class="field col-6">
              <label class="label" for="evt_time">Time</label>
              <input id="evt_time" class="input" type="time" name="time">
            </div>
            <div class="field col-12">
              <label class="label" for="evt_title">Title</label>
              <input id="evt_title" class="input" type="text" name="title" placeholder="Follow-up call with Acme" required>
            </div>
            <div class="field col-12">
              <label class="label" for="evt_notes">Notes</label>
              <textarea id="evt_notes" class="textarea" name="notes" rows="3" placeholder="Key points for the call‚Ä¶"></textarea>
            </div>
            <div class="field col-12">
              <label class="label" for="evt_type">Type</label>
              <select id="evt_type" class="select" name="type">
                <option value="call" selected>Call</option>
                <option value="visit">Customer Visit</option>
                <option value="demo">Site Demo</option>
              </select>
            </div>
          </div>
        </div>
        <div class="foot">
          <button class="btn" type="button" onclick="document.getElementById('newEventModal').classList.remove('open')">Cancel</button>
          <button class="btn primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Events JSON -->
  <script id="events-json" type="application/json">
    {{ event_map | tojson }}
  </script>

  <script>
    // ===== Calendar logic (fixed-size cells + "+N more") =====
    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    const grid = document.getElementById('calGrid');
    let y = parseInt(grid.dataset.year || new Date().getFullYear(), 10);
    let m = parseInt(grid.dataset.month || (new Date().getMonth()+1), 10); // 1-12
    const events = JSON.parse(document.getElementById('events-json').textContent || "{}"); // { "YYYY-MM-DD": [ {title,time,notes,type} ] }

    const titleEl = document.getElementById('calTitle');
    const dayModal = document.getElementById('dayModal');
    const dayBody  = document.getElementById('dayBody');
    const dayTitle = document.getElementById('dayTitle');

    const MAX_CHIPS = 2; // show up to 2 chips in a cell; rest goes to "+N more"

    function pad(n){ return String(n).padStart(2,'0'); }
    function daysInMonth(year, month){ return new Date(year, month, 0).getDate(); }
    function todayISO(){ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }

    function openDayModal(iso, label){
      const list = events[iso] || [];
      dayTitle.textContent = label;
      dayBody.innerHTML = list.length
        ? list.map(e => `
            <div class="event ${e.type ? e.type : 'call'}">
              ${e.time ? `<strong>${e.time}</strong> ‚Äî ` : ""}${e.title}
              ${e.notes ? `<div class="subtle" style="margin-top:4px">${e.notes}</div>` : ""}
            </div>`).join("")
        : `<div class="empty">No events for this day.</div>`;
      dayModal.classList.add('open');
    }

    function drawCalendar(year, month){
      grid.innerHTML = "";
      titleEl.textContent = `${monthNames[month-1]} ${year}`;

      const first = new Date(year, month-1, 1);
      const startDay = first.getDay();
      const totalDays = daysInMonth(year, month);
      const totalCells = 42;
      const tISO = todayISO();
      const frag = document.createDocumentFragment();

      for(let cell=0; cell<totalCells; cell++){
        const box = document.createElement('div');
        box.className = 'day';

        const dayNum = cell - startDay + 1;
        if (dayNum > 0 && dayNum <= totalDays){
          const iso = `${year}-${pad(month)}-${pad(dayNum)}`;
          const label = `${monthNames[month-1]} ${dayNum}, ${year}`;

          const dEl = document.createElement('div');
          dEl.className = 'dnum';
          dEl.textContent = dayNum;
          box.appendChild(dEl);

          if (iso === tISO){ box.classList.add('today'); }

          const wrap = document.createElement('div');
          wrap.className = 'events';
          box.appendChild(wrap);

          const list = events[iso] || [];
          list.slice(0, MAX_CHIPS).forEach(e=>{
            const chip = document.createElement('div');
            chip.className = 'event ' + (e.type ? e.type : 'call');
            chip.textContent = e.time ? `${e.time} ‚Äî ${e.title}` : e.title;
            wrap.appendChild(chip);
          });

          if (list.length > MAX_CHIPS){
            const more = document.createElement('button');
            more.className = 'more-link';
            more.type = 'button';
            more.textContent = `+${list.length - MAX_CHIPS} more`;
            more.addEventListener('click', (ev)=>{ ev.stopPropagation(); openDayModal(iso, label); });
            wrap.appendChild(more);
          }

          box.addEventListener('click', ()=> openDayModal(iso, label));
        }else{
          box.style.background = '#0f1318';
          box.style.opacity = .55;
        }
        frag.appendChild(box);
      }
      grid.appendChild(frag);
    }

    function navigate(delta){
      m += delta;
      if (m <= 0){ m = 12; y -= 1; }
      if (m > 12){ m = 1; y += 1; }
      drawCalendar(y, m);
    }

    document.getElementById('prevBtn').addEventListener('click', ()=>navigate(-1));
    document.getElementById('nextBtn').addEventListener('click', ()=>navigate(1));
    document.getElementById('todayBtn').addEventListener('click', ()=>{
      const d = new Date(); y = d.getFullYear(); m = d.getMonth()+1; drawCalendar(y, m);
    });

    drawCalendar(y, m);

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/sw.js').catch(()=>{});
    }
  </script>
</body>
</html>
